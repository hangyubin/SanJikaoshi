name: Cleanup Old Workflow Runs

# 每月1号和15号运行，或者手动触发
on:
  schedule:
    - cron: '0 0 1,15 * *' # 每月1号和15号运行
  workflow_dispatch: # 支持手动触发

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write # 需要写入权限来删除工作流运行

    steps:
      - name: Cleanup old workflow runs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // 配置要保留的工作流运行数量
            const keepRuns = 7;
            
            // 获取仓库所有者和名称
            const { owner, repo } = context.repo;
            
            // 获取所有工作流
            const workflows = await github.rest.actions.listRepoWorkflows({ owner, repo });
            
            // 遍历每个工作流
            for (const workflow of workflows.data.workflows) {
              console.log(`处理工作流: ${workflow.name} (ID: ${workflow.id})`);
              
              // 获取该工作流的所有运行记录
              let runs = await github.rest.actions.listWorkflowRuns({ 
                owner, 
                repo, 
                workflow_id: workflow.id,
                per_page: 100 // 每次获取100条记录
              });
              
              let allRuns = runs.data.workflow_runs;
              
              // 如果记录超过100条，继续获取
              while (runs.data.total_count > allRuns.length) {
                runs = await github.rest.actions.listWorkflowRuns({ 
                  owner, 
                  repo, 
                  workflow_id: workflow.id,
                  per_page: 100,
                  page: Math.floor(allRuns.length / 100) + 1
                });
                allRuns = [...allRuns, ...runs.data.workflow_runs];
              }
              
              console.log(`找到 ${allRuns.length} 条运行记录`);
              
              // 按创建时间降序排序
              allRuns.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
              
              // 如果记录超过keepRuns条，删除多余的
              if (allRuns.length > keepRuns) {
                const runsToDelete = allRuns.slice(keepRuns);
                console.log(`需要删除 ${runsToDelete.length} 条记录`);
                
                // 遍历删除多余的记录
                for (const run of runsToDelete) {
                  console.log(`删除运行记录: ${run.id} (${run.name} - ${run.created_at})`);
                  try {
                    await github.rest.actions.deleteWorkflowRun({ 
                      owner, 
                      repo, 
                      run_id: run.id 
                    });
                    console.log(`成功删除运行记录: ${run.id}`);
                  } catch (error) {
                    console.error(`删除运行记录失败: ${run.id}`, error);
                  }
                }
              } else {
                console.log(`记录数量 (${allRuns.length}) 未超过保留数量 (${keepRuns})，无需删除`);
              }
            }
            
            console.log('清理完成！');
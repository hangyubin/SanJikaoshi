name: Release Docker Images

on:
  release:
    types: [ published ]

jobs:
  release-docker-images:
    runs-on: ubuntu-latest
    steps:
      # 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 设置 Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 登录到 GitHub Container Registry
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 设置小写仓库名称
      - name: Set lowercase repository name
        id: repo
        run: echo "LOWERCASE_REPO=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      # 构建并保存完整应用镜像
      - name: Build and save full app image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ env.LOWERCASE_REPO }}:latest
            ghcr.io/${{ env.LOWERCASE_REPO }}:${{ github.sha }}
            ghcr.io/${{ env.LOWERCASE_REPO }}:${{ github.event.release.tag_name }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 构建并保存后端镜像
      - name: Build and save backend image
        uses: docker/build-push-action@v5
        with:
          context: ./server
          push: true
          tags: |
            ghcr.io/${{ env.LOWERCASE_REPO }}/backend:latest
            ghcr.io/${{ env.LOWERCASE_REPO }}/backend:${{ github.sha }}
            ghcr.io/${{ env.LOWERCASE_REPO }}/backend:${{ github.event.release.tag_name }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 构建并保存前端镜像
      - name: Build and save frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./client
          push: true
          tags: |
            ghcr.io/${{ env.LOWERCASE_REPO }}/frontend:latest
            ghcr.io/${{ env.LOWERCASE_REPO }}/frontend:${{ github.sha }}
            ghcr.io/${{ env.LOWERCASE_REPO }}/frontend:${{ github.event.release.tag_name }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 下载镜像并打包成tar文件
      - name: Save docker images to tar files
        run: |
          # 创建输出目录
          mkdir -p ./docker-images
          
          # 下载并保存完整应用镜像
          docker pull ghcr.io/${{ github.repository }}:${{ github.event.release.tag_name }} --platform=linux/amd64
          docker pull ghcr.io/${{ github.repository }}:${{ github.event.release.tag_name }} --platform=linux/arm64
          docker save -o ./docker-images/smart-exam-system-amd64.tar ghcr.io/${{ github.repository }}:${{ github.event.release.tag_name }} --platform=linux/amd64
          docker save -o ./docker-images/smart-exam-system-arm64.tar ghcr.io/${{ github.repository }}:${{ github.event.release.tag_name }} --platform=linux/arm64
          
          # 下载并保存后端镜像
          docker pull ghcr.io/${{ github.repository }}/backend:${{ github.event.release.tag_name }} --platform=linux/amd64
          docker pull ghcr.io/${{ github.repository }}/backend:${{ github.event.release.tag_name }} --platform=linux/arm64
          docker save -o ./docker-images/smart-exam-system-backend-amd64.tar ghcr.io/${{ github.repository }}/backend:${{ github.event.release.tag_name }} --platform=linux/amd64
          docker save -o ./docker-images/smart-exam-system-backend-arm64.tar ghcr.io/${{ github.repository }}/backend:${{ github.event.release.tag_name }} --platform=linux/arm64
          
          # 下载并保存前端镜像
          docker pull ghcr.io/${{ github.repository }}/frontend:${{ github.event.release.tag_name }} --platform=linux/amd64
          docker pull ghcr.io/${{ github.repository }}/frontend:${{ github.event.release.tag_name }} --platform=linux/arm64
          docker save -o ./docker-images/smart-exam-system-frontend-amd64.tar ghcr.io/${{ github.repository }}/frontend:${{ github.event.release.tag_name }} --platform=linux/amd64
          docker save -o ./docker-images/smart-exam-system-frontend-arm64.tar ghcr.io/${{ github.repository }}/frontend:${{ github.event.release.tag_name }} --platform=linux/arm64
          
          # 压缩tar文件
          gzip ./docker-images/*.tar
          
          # 列出文件
          ls -la ./docker-images/

      # 上传镜像到GitHub Releases
      - name: Upload images to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ./docker-images/smart-exam-system-amd64.tar.gz
            ./docker-images/smart-exam-system-arm64.tar.gz
            ./docker-images/smart-exam-system-backend-amd64.tar.gz
            ./docker-images/smart-exam-system-backend-arm64.tar.gz
            ./docker-images/smart-exam-system-frontend-amd64.tar.gz
            ./docker-images/smart-exam-system-frontend-arm64.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 输出结果
      - name: Output release results
        run: |
          echo "Docker images uploaded to GitHub Releases successfully!"
          echo "Release tag: ${{ github.event.release.tag_name }}"
          echo "Release URL: ${{ github.event.release.html_url }}"
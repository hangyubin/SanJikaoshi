name: Build and Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # 构建和测试后端
  build-backend:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
    
    - name: Set up Maven
      uses: stCarolas/setup-maven@v4.5
      with:
        maven-version: 3.8.8
    
    - name: Build backend with Maven
      run: cd backend && mvn clean package -DskipTests
    
    - name: Run backend tests
      run: cd backend && mvn test
    
    - name: Build backend Docker image
      run: cd backend && docker build -t smart-exam-backend .
  
  # 构建和测试前端
  build-frontend:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install frontend dependencies
      run: cd frontend && npm install
    
    - name: Build frontend
      run: cd frontend && npm run build
    
    - name: Build frontend Docker image
      run: cd frontend && docker build -t smart-exam-frontend .
  
  # 使用docker-compose构建整个项目
  build-docker-compose:
    runs-on: ubuntu-latest
    needs: [ build-backend, build-frontend ]
    steps:
    - uses: actions/checkout@v4
    
    - name: Build with docker-compose
      run: docker-compose build
    
    - name: Run docker-compose up
      run: docker-compose up -d
      timeout-minutes: 5
    
    - name: Check service status
      run: docker-compose ps
    
    - name: Stop services
      run: docker-compose down
name: Build and Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # 构建和测试后端
  build-server:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
    
    - name: Set up Maven
      uses: stCarolas/setup-maven@v4.5
      with:
        maven-version: 3.8.8
    
    - name: Build server with Maven
      run: cd server && mvn clean package -DskipTests
    
    - name: Run server tests
      run: cd server && mvn test
  
  # 构建和测试前端
  build-client:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install client dependencies
      run: cd client && npm install --legacy-peer-deps
    
    - name: Build client
      run: cd client && npm run build
  
  # 构建单一Docker镜像
  build-docker-image:
    runs-on: ubuntu-latest
    needs: [ build-server, build-client ]
    steps:
    - uses: actions/checkout@v4
    
    - name: Build single app Docker image
      run: docker build -t smart-exam-app .
  
  # 使用docker compose构建整个项目
  build-docker-compose:
    runs-on: ubuntu-latest
    needs: [ build-docker-image ]
    steps:
    - uses: actions/checkout@v4
    
    - name: Build with docker compose
      run: docker compose build
    
    - name: Run docker compose up
      run: docker compose up -d
      timeout-minutes: 5
    
    - name: Check service status
      run: docker compose ps
    
    - name: Stop services
      run: docker compose down
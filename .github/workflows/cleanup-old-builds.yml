name: Cleanup Old Builds

on:
  schedule:
    # 每天凌晨1点运行一次
    - cron: '0 1 * * *'
  workflow_run:
    # 每次构建完成后运行
    workflows: ["Docker Build and Push", "Release Docker Images"]
    types: [completed]

jobs:
  cleanup-old-builds:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    steps:
      - name: Cleanup Old Builds
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // 获取所有工作流
            const workflows = await github.rest.actions.listWorkflows({ 
              owner: context.repo.owner, 
              repo: context.repo.repo 
            });
            
            // 遍历所有工作流
            for (const workflow of workflows.data.workflows) {
              console.log(`Processing workflow: ${workflow.name} (${workflow.id})`);
              
              // 获取该工作流的所有构建
              let runs = await github.paginate(
                github.rest.actions.listWorkflowRuns, 
                {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: workflow.id,
                  per_page: 100
                }
              );
              
              // 按创建时间降序排序
              runs.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
              
              console.log(`Total runs for ${workflow.name}: ${runs.length}`);
              
              // 只保留最新的3个构建
              if (runs.length > 3) {
                const runsToDelete = runs.slice(3);
                console.log(`Will delete ${runsToDelete.length} old runs for ${workflow.name}`);
                
                // 删除旧构建
                for (const run of runsToDelete) {
                  console.log(`Deleting run ${run.id} (${run.created_at}) for ${workflow.name}`);
                  await github.rest.actions.deleteWorkflowRun({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    run_id: run.id
                  });
                  // 添加延迟，避免API速率限制
                  await new Promise(resolve => setTimeout(resolve, 1000));
                }
              } else {
                console.log(`No need to delete runs for ${workflow.name}, only ${runs.length} runs found`);
              }
            }
            
            console.log("Cleanup completed successfully!");
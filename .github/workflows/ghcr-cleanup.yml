name: Cleanup Old Images from GHCR

on:
  schedule:
    # 每月1号和15号凌晨2点运行
    - cron: '0 2 1,15 * *'
  workflow_dispatch:
    # 支持手动触发
    inputs:
      keep_tags:
        description: 'Number of tags to keep per image (default: 5)'
        required: false
        default: '5'
      dry_run:
        description: 'Dry run mode (true/false, default: false)'
        required: false
        default: 'false'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
      actions: write

    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup old images
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // 配置
            const keepTags = parseInt('${{ github.event.inputs.keep_tags || 5 }}');
            const dryRun = ${{ github.event.inputs.dry_run || 'false' }};
            const owner = '${{ github.repository_owner }}';
            
            // 定义要清理的镜像列表
            const images = [
              'sanjicms/app'  // 镜像名称（与GitHub仓库名称一致）
            ];
            
            for (const repo of images) {
              console.log(`\n开始清理 GHCR 镜像: ghcr.io/${owner}/${repo}`);
              console.log(`保留最新的 ${keepTags} 个标签`);
              console.log(`Dry run 模式: ${dryRun}`);
              
              // 获取所有镜像标签 - 支持个人仓库和组织仓库
              async function getImageTags() {
                let allTags = [];
                let page = 1;
                const perPage = 100;
                
                while (true) {
                  try {
                    let response;
                    try {
                      // 首先尝试组织仓库API
                      response = await github.rest.packages.getAllPackageVersionsForPackageOwnedByOrg({
                        package_type: 'container',
                        package_name: repo,
                        org: owner,
                        per_page: perPage,
                        page: page
                      });
                    } catch (orgError) {
                      // 如果组织仓库API失败，尝试个人仓库API
                      response = await github.rest.packages.getAllPackageVersionsForPackageOwnedByUser({
                        package_type: 'container',
                        package_name: repo,
                        username: owner,
                        per_page: perPage,
                        page: page
                      });
                    }
                    
                    allTags = allTags.concat(response.data);
                    
                    if (response.data.length < perPage) {
                      break;
                    }
                    
                    page++;
                  } catch (error) {
                    if (error.status === 404) {
                      console.log(`镜像仓库 ${repo} 不存在，跳过清理`);
                      return [];
                    }
                    console.error(`获取镜像标签失败: ${error.message}`);
                    return [];
                  }
                }
                
                return allTags;
              }
              
              // 删除镜像标签 - 支持个人仓库和组织仓库
              async function deleteImageTag(tagId) {
                try {
                  try {
                    // 首先尝试组织仓库API
                    await github.rest.packages.deletePackageVersionForOrg({
                      package_type: 'container',
                      package_name: repo,
                      org: owner,
                      package_version_id: tagId
                    });
                  } catch (orgError) {
                    // 如果组织仓库API失败，尝试个人仓库API
                    await github.rest.packages.deletePackageVersionForUser({
                      package_type: 'container',
                      package_name: repo,
                      username: owner,
                      package_version_id: tagId
                    });
                  }
                  return true;
                } catch (error) {
                  console.error(`删除标签失败: ${error.message}`);
                  return false;
                }
              }
              
              // 获取并清理镜像标签
              const tags = await getImageTags();
              if (tags.length === 0) {
                continue;
              }
              
              // 按创建时间降序排序
              tags.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
              
              console.log(`找到 ${tags.length} 个标签`);
              
              // 如果标签数量超过要保留的数量，则删除多余的标签
              if (tags.length > keepTags) {
                const tagsToDelete = tags.slice(keepTags);
                console.log(`准备删除 ${tagsToDelete.length} 个旧标签`);
                
                // 遍历删除旧标签
                let deletedCount = 0;
                for (const tag of tagsToDelete) {
                  console.log(`- ${tag.name} (创建于: ${tag.created_at})`);
                  
                  if (!dryRun) {
                    const success = await deleteImageTag(tag.id);
                    if (success) {
                      console.log(`  ✅ 成功删除`);
                      deletedCount++;
                    } else {
                      console.log(`  ❌ 删除失败`);
                    }
                  }
                }
                
                console.log(`清理完成！共删除 ${deletedCount} 个标签${dryRun ? '（Dry run 模式，未实际删除）' : ''}`);
              } else {
                console.log(`标签数量 (${tags.length}) 未超过保留数量 (${keepTags})，无需清理`);
              }
            }
            
            console.log('\n所有镜像清理完成！');